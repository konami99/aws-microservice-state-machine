AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Sample template to deliver events from Amazon EventBridge to CloudWatch Logs

Resources:
  StateMachineLogs:
    Type: AWS::Logs::LogGroup

  StateMachineForWeatherData:
    Type: AWS::Serverless::StateMachine
    Properties:
      # Logging is a good idea. We also need at least one policy attached to the Step
      # Function in order to deploy.
      Logging:
        Level: ERROR
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StateMachineLogs.Arn
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - logs:*
            Resource: "*"
      Definition:
        StartAt: What Happened?
        States:
          # The three states that trigger this Step Function each have their own path.
          What Happened?:
            Type: Choice
            Choices:
              - Variable: $.state
                StringEquals: running
                Next: It's Running
              - Variable: $.state
                StringEquals: stopped
                Next: It's Stopped
              - Variable: $.state
                StringEquals: terminated
                Next: It's Gone
          # These Pass states can be replaced to contain business logic for reacting to
          # state changes. See other Step Function to Service patterns for examples.
          It's Running:
            Type: Pass
            End: true
          It's Stopped:
            Type: Pass
            End: true
          It's Gone:
            Type: Pass
            End: true
      Events:
        StateChange:
          Type: EventBridgeRule
          Properties:
            EventBusName: default
            # The detail key contains the EC2 specific event data. In this example, the
            # rest of the event properties are not needed and discarded.
            InputPath: $.detail
            Pattern:
              source:
                - aws.lambda

  LogsRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: default
      EventPattern:
        source: 
          - 'demo.event'
        account:
          - !Ref AWS::AccountId
      Targets:
        - Arn: !GetAtt LogGroupForEvents.Arn
          Id: LogTarget
  LogGroupForEvents:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/events/state-machine-test
  LogGroupForEventsPolicy:
    Type: AWS::Logs::ResourcePolicy
    Properties:
      PolicyName: EventBridgeToCWLogsPolicy
      PolicyDocument: !Sub >
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "EventBridgetoCWLogsCreateLogStreamPolicy",
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "events.amazonaws.com"
                ]
              },
              "Action": [
                "logs:CreateLogStream"
              ],
              "Resource": [
                "${LogGroupForEvents.Arn}"
              ]
            },
            {
              "Sid": "EventBridgetoCWLogsPutLogEventsPolicy",
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "events.amazonaws.com"
                ]
              },
              "Action": [
                "logs:PutLogEvents"
              ],
              "Resource": [
                "${LogGroupForEvents.Arn}"
              ],
              "Condition": {
                "ArnEquals": {"AWS:SourceArn": "${LogsRule.Arn}"}
              }
            }
          ]
        }